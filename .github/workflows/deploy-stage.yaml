
name: deploy to stage
on:
  push:
    branches:
      - master
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:

      ##
      ## checkout and build
      ##

      - name: checkout
        uses: actions/checkout@v2

      - name: npm install and build
        shell: bash
        run: npm install -s && npm run build -s

      ##
      ## push web image
      ##

      - name: push web image
        uses: docker/build-push-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ github.token }}
          registry: docker.pkg.github.com
          repository: chase-moskal/metalshop/auth-server
          tags: ${{ github.sha }}
          dockerfile: ./source/microservices/auth-server/Dockerfile

      ##
      ## push images for microservices
      ##

      - name: push auth-server image
        uses: docker/build-push-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: docker.pkg.github.com
          repository: chase-moskal/metalshop/auth-server
          tags: ${{ github.sha }}
          dockerfile: ./source/microservices/auth-server/Dockerfile


      - name: push liveshow-server image
        uses: docker/build-push-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: docker.pkg.github.com
          repository: chase-moskal/metalshop/liveshow-server
          tags: ${{ github.sha }}
          dockerfile: ./source/microservices/liveshow-server/Dockerfile


      - name: push paywall-server image
        uses: docker/build-push-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: docker.pkg.github.com
          repository: chase-moskal/metalshop/paywall-server
          tags: ${{ github.sha }}
          dockerfile: ./source/microservices/paywall-server/Dockerfile

      - name: push questions-server image
        uses: docker/build-push-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: docker.pkg.github.com
          repository: chase-moskal/metalshop/questions-server
          tags: ${{ github.sha }}
          dockerfile: ./source/microservices/questions-server/Dockerfile


      - name: push schedule-server image
        uses: docker/build-push-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: docker.pkg.github.com
          repository: chase-moskal/metalshop/schedule-server
          tags: ${{ github.sha }}
          dockerfile: ./source/microservices/schedule-server/Dockerfile


      - name: push settings-server image
        uses: docker/build-push-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: docker.pkg.github.com
          repository: chase-moskal/metalshop/settings-server
          tags: ${{ github.sha }}
          dockerfile: ./source/microservices/settings-server/Dockerfile

      ##
      ## deploy to stage
      ##

      - name: set kubeconfig
        uses: azure/k8s-set-context@v1
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}
        id: setcontext

      - name: helm deployment
        shell: bash
        env:
          GITSHA: ${{ github.sha }}
        run: |
          helm upgrade metalstage ./metalback \
            --wait \
            --install \
            --namespace metalshop \
            --set images.tag=$GITSHA \
            -f ./metalback/values-stage.yaml \
          || helm rollback metalstage

      # - name: set azure kubectl context
      #   uses: azure/aks-set-context@v1
      #   with:
      #       creds: '${{ secrets.AKS_CREDENTIALS }}'
      #       resource-group: workgroup
      #       cluster-name: workback
      #   id: login
      # - name: production deployment
      #   shell: bash
      #   env:
      #     METALBACK_CONFIG: '${{ secrets.METALBACK_CONFIG }}'
      #     AUTH_SERVER_PUBLIC_PEM: '${{ secrets.AUTH_SERVER_PUBLIC_PEM }}'
      #     AUTH_SERVER_PRIVATE_PEM: '${{ secrets.AUTH_SERVER_PRIVATE_PEM }}'
      #   run: |
      #     cd metalback
      #     rm -rf config && mkdir config
      #     echo "$METALBACK_CONFIG" > config/config.yaml
      #     echo "$AUTH_SERVER_PUBLIC_PEM" > config/auth-server.public.pem
      #     echo "$AUTH_SERVER_PRIVATE_PEM" > config/auth-server.private.pem
      #     ./proddeploy

      ##
      ## deploy frontend to github pages
      ##

      # - name: gh-pages deploy
      #   shell: bash
      #   run: |
      #     git config --global user.email "chasemoskal@gmail.com"
      #     git config --global user.name "Robotic Chase (CI/CD)"
      #     git fetch origin master \
      #       && git fetch origin gh-pages \
      #       && git checkout --track origin/gh-pages \
      #       && git rebase --onto origin/master origin/gh-pages~3 gh-pages \
      #       && npm install -s \
      #       && npm run build -s \
      #       && git add . \
      #       && git commit --amend --no-edit --reset-author \
      #       && git push -f
